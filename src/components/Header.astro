---
import { SITE_TITLE } from "../consts";
import HeaderLink from "./HeaderLink.astro";
import ThemeIcon from "./ThemeIcon.astro";
import LanguagePicker from "./LanguagePicker.astro";
import { getLangFromUrl, useTranslations, getLocalizedPath } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navLinks = [
  { href: getLocalizedPath("", lang), text: t("nav.home") },
  { href: getLocalizedPath("blog", lang), text: t("nav.blog") },
  { href: getLocalizedPath("about", lang), text: t("nav.about") },
  { href: `https://nakayamaken.com/${lang}/osaka/`, text: t("nav.osaka") },
];
---

<header class="sticky top-0 z-50 m-0 px-4 py-3 backdrop-blur-md bg-white/80 dark:bg-gray-900/80 border-b border-gray-200/50 dark:border-gray-700/50 shadow-lg shadow-gray-200/50 dark:shadow-gray-900/50 transition-all duration-300">
  <nav class="max-w-6xl mx-auto flex items-center justify-between">
    <h2 class="m-0 text-lg font-bold">
      <a
        href="/"
        class="no-underline text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 dark:from-blue-400 dark:via-purple-400 dark:to-pink-400 hover:from-pink-600 hover:via-purple-600 hover:to-blue-600 dark:hover:from-pink-400 dark:hover:via-purple-400 dark:hover:to-blue-400 transition-all duration-500"
      >
        {SITE_TITLE}
      </a>
    </h2>

    <!-- Desktop Menu -->
    <div class="hidden md:flex gap-1 items-center">
      {navLinks.map((link) => (<HeaderLink href={link.href}>{link.text}</HeaderLink>))}
      <div class="ml-2 pl-2 border-l border-gray-300 dark:border-gray-600 flex items-center gap-2">
        <LanguagePicker />
        <ThemeIcon />
      </div>
    </div>

    <!-- Mobile Controls (Right side) -->
    <div class="md:hidden flex items-center gap-3 ml-auto">
      <LanguagePicker />
      <ThemeIcon />
      <button
        id="menu-btn"
        class="relative flex flex-col gap-1.5 p-2.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-all duration-300 group [&.open_.menu-line:nth-child(1)]:translate-y-[8px] [&.open_.menu-line:nth-child(1)]:rotate-45 [&.open_.menu-line:nth-child(2)]:opacity-0 [&.open_.menu-line:nth-child(2)]:translate-x-2 [&.open_.menu-line:nth-child(3)]:-translate-y-[8px] [&.open_.menu-line:nth-child(3)]:-rotate-45"
        aria-label="Toggle menu"
      >
        <span class="menu-line w-6 h-0.5 bg-gradient-to-r from-blue-600 to-purple-600 dark:from-blue-400 dark:to-purple-400 rounded-full transition-all duration-300"></span>
        <span class="menu-line w-6 h-0.5 bg-gradient-to-r from-purple-600 to-pink-600 dark:from-purple-400 dark:to-pink-400 rounded-full transition-all duration-300"></span>
        <span class="menu-line w-6 h-0.5 bg-gradient-to-r from-pink-600 to-blue-600 dark:from-pink-400 dark:to-blue-400 rounded-full transition-all duration-300"></span>
      </button>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="md:hidden overflow-hidden transition-all duration-500 ease-in-out max-h-0 opacity-0 [&.open]:max-h-96 [&.open]:opacity-100"
  >
    <div class="flex flex-col gap-2 pt-4 pb-2">
      {navLinks.map((link) => (
        <div class="transform transition-all duration-300 hover:translate-x-1">
          <HeaderLink href={link.href}>{link.text}</HeaderLink>
        </div>
      ))}
    </div>
  </div>
</header>

<script is:inline>
  (() => {
    // Mobile menu toggle (event delegation)
    document.addEventListener('click', (e) => {
      const target = e.target;
      
      // Handle menu button click
      const menuBtn = target.closest('#menu-btn');
      if (menuBtn) {
        e.stopPropagation();
        menuBtn.classList.toggle('open');
        document.getElementById('mobile-menu')?.classList.toggle('open');
        return;
      }
      
      // Handle theme toggle click
      const themeBtn = target.closest('#themeToggle');
      if (themeBtn) {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        return;
      }
      
      // Handle language picker click
      const languageBtn = target.closest('.language-picker-btn');
      if (languageBtn) {
        e.stopPropagation();
        const picker = languageBtn.closest('.language-picker');
        const menu = picker?.querySelector('.language-picker-menu');
        
        if (menu) {
          // Close all other language menus first
          document.querySelectorAll('.language-picker-menu.open').forEach(m => {
            if (m !== menu) m.classList.remove('open');
          });
          // Toggle this menu
          menu.classList.toggle('open');
        }
        return;
      }
      
      // Close mobile menu on outside click
      const mobileMenu = document.getElementById('mobile-menu');
      const menuButton = document.getElementById('menu-btn');
      if (mobileMenu && menuButton && 
          !menuButton.contains(target) && 
          !mobileMenu.contains(target)) {
        menuButton.classList.remove('open');
        mobileMenu.classList.remove('open');
      }
      
      // Close language menus on outside click
      if (!target.closest('.language-picker')) {
        document.querySelectorAll('.language-picker-menu.open').forEach(menu => {
          menu.classList.remove('open');
        });
      }
    });
    
    // Close mobile menu and language menus on page navigation
    document.addEventListener('astro:page-load', () => {
      document.getElementById('menu-btn')?.classList.remove('open');
      document.getElementById('mobile-menu')?.classList.remove('open');
      document.querySelectorAll('.language-picker-menu').forEach(menu => {
        menu.classList.remove('open');
      });
    });
  })();
</script>
